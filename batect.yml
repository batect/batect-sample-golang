containers:
  build-env:
    build_directory: dev-infrastructure/build-env
    volumes:
      - local: .
        container: /code
        options: cached
      - local: .go-cache
        container: /go
        options: delegated
    working_directory: /code
    run_as_current_user:
      enabled: true
      home_directory: /home/container-user

  app:
    build_directory: dev-infrastructure/app

tasks:
  setup:
    description: Download all dependencies used by the application.
    group: Setup tasks
    run:
      container: build-env
      command: go mod download

  build:
    description: Build the application.
    group: Build tasks
    run:
      container: build-env
      command: go build -o dev-infrastructure/app/batect-sample-golang .

  unitTest:
    description: Run the unit tests.
    group: Test tasks
    run:
      container: build-env
      command: go test

  shell:
    description: Start a shell in the development environment.
    group: Utility tasks
    run:
      container: build-env
      command: bash

  run:
    description: Run the application.
    group: Test tasks
    prerequisites:
      - build
    run:
      container: app

  checkFormatting:
    description: Check all files are formatted according to the Golang standard.
    group: Linting tasks
    run:
      container: build-env
      command: ./util/checkFormatting.sh

  vet:
    description: Check for errors reported by 'go vet'.
    group: Linting tasks
    run:
      container: build-env
      command: go vet

  update:
    description: Update to latest minor or patch update of all dependencies.
    group: Dependency management tasks
    run:
      container: build-env
      command: sh -c 'go get -u && go mod tidy'
